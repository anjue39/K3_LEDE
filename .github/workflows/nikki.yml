#
# Phicomm K3 终极专用版 —— 2025.12.10 亲测 100% 成功（Ubuntu 24.04）
#
name: nikki

on:
  workflow_dispatch

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  CONFIG_FILE: nikki.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_FIRMWARE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest                     # 2025 年就是 Ubuntu 24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ===================== Ubuntu 24.04 完全兼容依赖安装 =====================
      - name: Install dependencies (Ubuntu 24.04)
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository universe -y
          sudo add-apt-repository multiverse -y
          sudo apt-get update

          sudo apt-get install -y \
            ack asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache cmake cpio curl device-tree-compiler flex gawk \
            gcc g++ git gperf help2man libelf-dev libfuse3-dev libglib2.0-dev \
            libgmp-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libreadline-dev \
            libssl-dev libtool lrzsz msmtp nano ninja-build p7zip-full patch pkg-config \
            python3 python3-pip rsync scons squashfs-tools subversion swig texinfo \
            uglifyjs upx-ucl unzip vim wget xorriso zlib1g-dev

          # Ubuntu 24.04 彻底移除的包，用 pip 安装
          python3 -m pip install --break-system-packages pyelftools

          sudo apt-get clean
          sudo timedatectl set-timezone "$TZ"

      # ===================== 拉取 Lean 源码 =====================
      - name: Clone source code
        run: |
          git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
          ln -sf $(pwd)/openwrt $GITHUB_WORKSPACE/openwrt

      # ===================== 添加插件 & feeds =====================
      - name: Load custom feeds & plugins
        run: |
          [ -e feeds.conf.default ] && mv feeds.conf.default openwrt/feeds.conf.default
          [ -e $DIY_P1_SH ] && bash $DIY_P1_SH || echo "no diy-part1.sh"
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # ===================== 加载配置 =====================
      - name: Load config
        run: |
          [ -e files ] && mv files openwrt/files
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
          [ -e $DIY_P2_SH ] && bash $DIY_P2_SH || echo "no diy-part2.sh"
          cd openwrt
          make defconfig

      # ===================== 下载源码 =====================
      - name: Download packages
        run: |
          cd openwrt
          make download -j8 || true
          find dl -size -1024c -exec rm -f {} \;

      # ===================== 编译（单线程最稳）=====================
      - name: Compile firmware
        run: |
          cd openwrt
          echo "开始单线程编译（防止爆盘）"
          make -j1 V=s

      # ===================== K3 万能上传（兼容所有路径）=====================
      - name: Upload K3 Firmware
        uses: actions/upload-artifact@v4
        with:
          name: Phicomm_K3_${{ github.run_number }}_trx
          path: |
            openwrt/bin/targets/bcm53xx/generic/*phicomm_k3*.trx
            openwrt/bin/*phicomm_k3*.trx

      # ===================== 清理旧 workflow（可选）=====================
      - name: Delete old workflow runs
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 3
          keep_minimum_runs: 5
