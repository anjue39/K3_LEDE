#
# Phicomm K3 终极专用版 —— 一次改完，永不翻车（2025.12 亲测 100% 成功）
#
name: Build Phicomm K3

on:
  workflow_dispatch:                      # 手动触发
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  CONFIG_FILE: nikki.config             # 你的 .config 文件名
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_FIRMWARE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest               # 自动就是 ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ===================== 依赖安装（ubuntu-24.04 完全兼容）=====================
      - name: Install dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo apt-get -y update
          sudo apt-get -y install \
            ack asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib \
            gettext git gperf help2man libelf-dev libfuse-dev libglib2.0-dev libgmp-dev \
            libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev \
            libssl-dev libtool lrzsz xorriso msmtp nano ninja-build p7zip-full patch pkgconf \
            python3 python3-pip python3-pyelftools python3-setuptools qemu-utils rsync scons \
            squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          sudo apt-get -y autoremove --purge
          sudo apt-get -y clean
          sudo timedatectl set-timezone "$TZ"

      # ===================== 拉取 Lean 源码 =====================
      - name: Clone source code
        run: |
          git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
          ln -sf $(pwd)/openwrt $GITHUB_WORKSPACE/openwrt

      # ===================== 添加自定义 feeds 和插件 =====================
      - name: Load custom feeds & plugins
        run: |
          [ -e feeds.conf.default ] && mv feeds.conf.default openwrt/feeds.conf.default
          [ -e $DIY_P1_SH ] && bash $DIY_P1_SH || echo "no diy-part1.sh"
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # ===================== 加载配置 =====================
      - name: Load custom config
        run: |
          [ -e files ] && mv files openwrt/files
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
          [ -e $DIY_P2_SH ] && bash $DIY_P2_SH || echo "no diy-part2.sh"
          cd openwrt
          make defconfig

      # ===================== 下载源码 =====================
      - name: Download packages
        run: |
          cd openwrt
          make download -j8 || true
          find dl -size -1024c -exec rm -f {} \;

      # ===================== 编译（单线程最稳）=====================
      - name: Compile firmware
        id: compile
        run: |
          cd openwrt
          echo "开始单线程编译（防止爆盘）"
          make -j1 V=s || make -j1 V=s || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT

      # ===================== K3 万能 Organize（兼容所有路径）=====================
      - name: Organize files (K3 万能版)
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true'
        run: |
          cd openwrt/bin

          # 情况1：标准路径
          if [ -d "targets/bcm53xx/generic" ]; then
            cd targets/bcm53xx/generic
            echo "使用标准路径 targets/bcm53xx/generic"

          # 情况2：K3 经典异常路径（固件直接在 bin 根目录）
          elif ls *phicomm_k3*.trx 1>/dev/null 2>&1; then
            echo "使用 K3 异常路径（已自动救活）"

          else
            echo "错误：完全没找到固件！"
            ls -la
            exit 1
          fi

          # 清理垃圾文件
          rm -rf packages *.manifest config.buildinfo feeds.buildinfo sha256sums version.buildinfo 2>/dev/null || true

          # 写入环境变量
          echo "FIRMWARE=$(pwd)" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      # ===================== 上传固件 =====================
      - name: Upload K3 Firmware
        uses: actions/upload-artifact@v4
        if: steps.organize.outputs.status == 'success'
        with:
          name: Phicomm_K3_${{ github.run_number }}_trx
          path: ${{ env.FIRMWARE }}

      # ===================== 可选：清理旧 workflow =====================
      - name: Delete old workflow runs
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 3
          keep_minimum_runs: 5
