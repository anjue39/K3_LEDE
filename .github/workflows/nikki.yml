#
# 2025 年终极 K3 专用版 —— 一次改完，永不翻车
#

name: nikki

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: nikki.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest                     # 2025 年默认 ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean & install dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo apt-get -qq update
          sudo apt-get -qq install ack asciidoc autoconf automake binutils bison bzip2 ccache cmake cpio curl device-tree-compiler \
            flex gawk gcc-multilib g++-multilib gettext git gperf haveged help2man intltool libelf-dev libglib2.0-dev \
            libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev \
            libtool lrzsz mkisofs msmtp nano ninja-build p7zip-full patch pkgconf python3 python3-pyelftools python3-setuptools \
            qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          sudo apt-get -qq autoremove --purge
          sudo apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"

      - name: Clone source code
        run: |
          git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
          ln -sf $(pwd)/openwrt $GITHUB_WORKSPACE/openwrt

      - name: Load custom feeds
        run: |
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
          [ -e $DIY_P1_SH ] && bash $DIY_P1_SH || echo "no diy-part1.sh"
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Load custom config
        run: |
          [ -e files ] && mv files openwrt/files
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
          [ -e $DIY_P2_SH ] && bash $DIY_P2_SH || echo "no diy-part2.sh"
          cd openwrt
          make defconfig

      - name: Download packages
        run: |
          cd openwrt
          make download -j8
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile firmware (单线程防爆盘)
        id: compile
        run: |
          cd openwrt
          echo "开始单线程编译（最稳）"
          make -j1 V=s || make -j1 V=s || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT

      # ==================== K3 专用 Organize（兼容所有路径）====================
      - name: Organize files (K3 专用万能版)
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true'
        run: |
          cd openwrt/bin

          # 情况1：正常路径 targets/bcm53xx/generic/
          if [ -d "targets/bcm53xx/generic" ]; then
            cd targets/bcm53xx/generic
            echo "使用正常路径"

          # 情况2：K3 经典异常路径（固件直接在 bin 根目录）
          elif ls *phicomm_k3*.trx 1>/dev/null 2>&1; then
            echo "使用 K3 异常路径（已自动救活）"

          # 情况3：万一还是找不到，直接报错
          else
            echo "错误：完全没找到固件！"
            ls -la
            exit 1
          fi

          # 清理垃圾，只留 trx
          rm -rf packages *.manifest config.buildinfo feeds.buildinfo sha256sums version.buildinfo 2>/dev/null || true

          # 强制写入环境变量
          echo "FIRMWARE=$(pwd)" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      # ==================== 上传固件 ====================
      - name: Upload firmware (只传 trx 目录)
        uses: actions/upload-artifact@v4
        if: steps.organize.outputs.status == 'success'
        with:
          name: Phicomm_K3_${{ github.run_number }}
          path: ${{ env.FIRMWARE }}

      # ==================== 可选功能（按需开启）===================
      - name: Delete old workflow runs
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 2
          keep_minimum_runs: 5
